# 17_LA扩展_phase1抽样7天_node_metric_dominance_tidbfix_rerun

目标：在固定数据口径下，比较多种方案对 Final（以及 LA/TA/Explainability/Efficiency）的影响。

## 试验设置
- metadata: `/Users/hechenyu/projects/AIOPS/metadata_phase1.csv`
- ground truth: `/Users/hechenyu/projects/AIOPS/AIOpsChallengeJudge/ground_truth_phase1.jsonl`
- telemetry root: `/Users/hechenyu/projects/AIOPS/data`
- dates（按天全量）: 2025-06-13, 2025-06-07, 2025-06-11, 2025-06-08, 2025-06-10, 2025-06-09, 2025-06-14
- suite slug: `la_v7_node_metric_dom_p1_seed7_tidbfix_rerun`（对应 outputs/experiments/la_v7_node_metric_dom_p1_seed7_tidbfix_rerun/）

## 候选方案
- 方案A：对照（dominance override 关闭）（key=base_safe）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_COMPONENT_PRIOR_SCALE": "1.0", "RCA_USE_LEGACY_MEMORY": "0", "RCA_STRIP_REPLICA_SUFFIX": "1", "RCA_ENABLE_TIDB_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_TIDB_DOMINANCE_MIN_METRIC": "2.6", "RCA_TIDB_DOMINANCE_MIN_RATIO": "0.55", "RCA_TIDB_DOMINANCE_MARGIN": "0.02", "RCA_TIDB_METRIC_SCORE_MULT": "1.8", "RCA_DISABLE_LLM": "1", "RCA_ENABLE_NODE_METRIC_DOMINANCE_OVERRIDE": "0"}`
- 方案B：开启 node metric dominance override（强 node 指标 + 竞争力阈值）（key=node_dominance_on）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_COMPONENT_PRIOR_SCALE": "1.0", "RCA_USE_LEGACY_MEMORY": "0", "RCA_STRIP_REPLICA_SUFFIX": "1", "RCA_ENABLE_TIDB_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_TIDB_DOMINANCE_MIN_METRIC": "2.6", "RCA_TIDB_DOMINANCE_MIN_RATIO": "0.55", "RCA_TIDB_DOMINANCE_MARGIN": "0.02", "RCA_TIDB_METRIC_SCORE_MULT": "1.8", "RCA_DISABLE_LLM": "1", "RCA_ENABLE_NODE_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_NODE_DOMINANCE_MIN_METRIC": "5.2", "RCA_NODE_DOMINANCE_MIN_RATIO": "0.6", "RCA_NODE_DOMINANCE_MARGIN": "0.03"}`
- 方案C：dominance override + 保留 replica 后缀（key=node_dominance_on_keep_replica）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_COMPONENT_PRIOR_SCALE": "1.0", "RCA_USE_LEGACY_MEMORY": "0", "RCA_STRIP_REPLICA_SUFFIX": "0", "RCA_ENABLE_TIDB_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_TIDB_DOMINANCE_MIN_METRIC": "2.6", "RCA_TIDB_DOMINANCE_MIN_RATIO": "0.55", "RCA_TIDB_DOMINANCE_MARGIN": "0.02", "RCA_TIDB_METRIC_SCORE_MULT": "1.8", "RCA_DISABLE_LLM": "1", "RCA_ENABLE_NODE_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_NODE_DOMINANCE_MIN_METRIC": "5.2", "RCA_NODE_DOMINANCE_MIN_RATIO": "0.6", "RCA_NODE_DOMINANCE_MARGIN": "0.03"}`

## 结果汇总（按日期评测；并给出跨日期平均）

| 方案 | 平均LA | 平均TA | 平均Explain | 平均Eff | 平均Final |
|---|---:|---:|---:|---:|---:|
| 方案A：对照（dominance override 关闭） | 11.41% | 55.42% | 6.56% | 70.18% | 34.41 |
| 方案B：开启 node metric dominance override（强 node 指标 + 竞争力阈值） | 14.12% | 50.36% | 6.94% | 81.87% | 34.67 |
| 方案C：dominance override + 保留 replica 后缀 | 17.99% | 48.82% | 10.38% | 81.87% | 35.95 |

## 分日期明细

| date | N | 方案key | LA | TA | Explain | Eff | Final |
|---|---:|---|---:|---:|---:|---:|---:|
| 2025-06-13 | 24.0 | base_safe | 4.17% | 41.67% | 10.71% | 81.87% | 27.59 |
| 2025-06-13 | 24.0 | node_dominance_on | 4.17% | 37.50% | 7.14% | 81.87% | 25.57 |
| 2025-06-13 | 24.0 | node_dominance_on_keep_replica | 4.17% | 29.17% | 7.14% | 81.87% | 22.23 |
| 2025-06-07 | 24.0 | base_safe | 20.83% | 50.00% | 8.70% | 81.87% | 37.39 |
| 2025-06-07 | 24.0 | node_dominance_on | 20.83% | 41.67% | 6.52% | 81.87% | 33.84 |
| 2025-06-07 | 24.0 | node_dominance_on_keep_replica | 25.00% | 45.83% | 8.70% | 81.87% | 37.39 |
| 2025-06-11 | 24.0 | base_safe | 16.67% | 58.33% | 6.52% | 81.87% | 38.84 |
| 2025-06-11 | 24.0 | node_dominance_on | 16.67% | 58.33% | 8.70% | 81.87% | 39.06 |
| 2025-06-11 | 24.0 | node_dominance_on_keep_replica | 29.17% | 58.33% | 17.39% | 81.87% | 44.93 |
| 2025-06-08 | 24.0 | base_safe | 4.17% | 50.00% | 0.00% | 81.87% | 29.85 |
| 2025-06-08 | 24.0 | node_dominance_on | 8.33% | 50.00% | 0.00% | 81.87% | 31.52 |
| 2025-06-08 | 24.0 | node_dominance_on_keep_replica | 12.50% | 45.83% | 3.70% | 81.87% | 31.89 |
| 2025-06-10 | 24.0 | base_safe | 16.67% | 58.33% | 14.29% | 81.87% | 39.62 |
| 2025-06-10 | 24.0 | node_dominance_on | 20.83% | 41.67% | 14.29% | 81.87% | 34.62 |
| 2025-06-10 | 24.0 | node_dominance_on_keep_replica | 20.83% | 41.67% | 14.29% | 81.87% | 34.62 |
| 2025-06-09 | 23.0 | base_safe | 17.39% | 60.87% | 5.71% | 81.87% | 40.06 |
| 2025-06-09 | 23.0 | node_dominance_on | 21.74% | 60.87% | 8.57% | 81.87% | 42.09 |
| 2025-06-09 | 23.0 | node_dominance_on_keep_replica | 21.74% | 52.17% | 11.43% | 81.87% | 38.90 |
| 2025-06-14 | 16.0 | base_safe | 0.00% | 68.75% | 0.00% | 0.00% | 27.50 |
| 2025-06-14 | 16.0 | node_dominance_on | 6.25% | 62.50% | 3.33% | 81.87% | 36.02 |
| 2025-06-14 | 16.0 | node_dominance_on_keep_replica | 12.50% | 68.75% | 10.00% | 81.87% | 41.69 |

## 预测 component 分布（Top-5）

说明：该表用于快速观察是否出现 ‘adservice 坍缩’（例如 Top-1 占比异常高）。

| date | 方案key | Top-5 components（component:count） |
|---|---|---|
| 2025-06-13 | base_safe | checkoutservice:8; adservice:7; tidb-pd-0:3; tidb-tidb-0:3; aiops-k8s-03:2 |
| 2025-06-13 | node_dominance_on | adservice:7; tidb-pd-0:3; tidb-tidb-0:3; aiops-k8s-01:2; aiops-k8s-03:2 |
| 2025-06-13 | node_dominance_on_keep_replica | adservice:7; aiops-k8s-01:3; checkoutservice:3; tidb-tidb-0:3; cartservice:2 |
| 2025-06-07 | base_safe | adservice:8; checkoutservice:5; tidb-tidb-0:3; aiops-k8s-04:2; tidb-tikv-0:2 |
| 2025-06-07 | node_dominance_on | adservice:8; aiops-k8s-01:2; aiops-k8s-04:2; aiops-k8s-07:2; tidb-tidb-0:2 |
| 2025-06-07 | node_dominance_on_keep_replica | adservice:8; checkoutservice:3; tidb-tidb-0:3; aiops-k8s-07:2; tidb-tikv-0:2 |
| 2025-06-11 | base_safe | adservice:9; aiops-k8s-07:4; checkoutservice:4; tidb-tikv-0:3; aiops-k8s-04:2 |
| 2025-06-11 | node_dominance_on | adservice:8; aiops-k8s-07:4; aiops-k8s-04:3; tidb-tikv-0:3; aiops-k8s-03:1 |
| 2025-06-11 | node_dominance_on_keep_replica | adservice:9; aiops-k8s-07:4; checkoutservice:4; aiops-k8s-04:2; aiops-k8s-03:1 |
| 2025-06-08 | base_safe | checkoutservice:8; adservice:7; tidb-tidb-0:4; tidb-tikv-0:3; aiops-k8s-04:1 |
| 2025-06-08 | node_dominance_on | adservice:7; aiops-k8s-04:3; tidb-tidb-0:3; aiops-k8s-01:2; aiops-k8s-07:2 |
| 2025-06-08 | node_dominance_on_keep_replica | adservice:7; checkoutservice:3; tidb-tidb-0:3; aiops-k8s-01:2; aiops-k8s-04:2 |
| 2025-06-10 | base_safe | checkoutservice:9; adservice:8; tidb-tidb-0:2; aiops-k8s-03:1; aiops-k8s-04:1 |
| 2025-06-10 | node_dominance_on | adservice:8; aiops-k8s-03:4; aiops-k8s-04:4; aiops-k8s-07:2; checkoutservice:2 |
| 2025-06-10 | node_dominance_on_keep_replica | adservice:9; aiops-k8s-03:4; aiops-k8s-04:3; aiops-k8s-07:2; checkoutservice:2 |
| 2025-06-09 | base_safe | adservice:8; checkoutservice:4; tidb-tidb-0:3; aiops-k8s-07:2; tidb-pd-0:2 |
| 2025-06-09 | node_dominance_on | adservice:8; tidb-tidb-0:3; aiops-k8s-03:2; aiops-k8s-07:2; checkoutservice:2 |
| 2025-06-09 | node_dominance_on_keep_replica | adservice:8; tidb-tidb-0:3; aiops-k8s-03:2; aiops-k8s-07:2; checkoutservice:2 |
| 2025-06-14 | base_safe | checkoutservice:6; tidb-tidb-0:5; aiops-k8s-03:2; tidb-pd-0:2; tidb-tikv-0:1 |
| 2025-06-14 | node_dominance_on | tidb-tidb-0:4; aiops-k8s-01:2; aiops-k8s-03:2; checkoutservice:2; k8s-master2:2 |
| 2025-06-14 | node_dominance_on_keep_replica | tidb-tidb-0:4; aiops-k8s-01:2; cartservice:2; checkoutservice:2; aiops-k8s-03:1 |

## 产物路径
- submissions: `outputs/experiments/la_v7_node_metric_dom_p1_seed7_tidbfix_rerun/`
- filtered gt: `tmp/filtered/` (gt_YYYY-MM-DD_*.jsonl)
