# 27c_LA修复_replica_hint优先_快验1+1天

目标：在 phase1+phase2 合并数据口径下，比较多种方案对 Final（以及 LA/TA/Explainability/Efficiency）的影响。

## 试验设置
- **phase1**:
  - metadata: `../metadata_phase1.csv`
  - ground truth: `../AIOpsChallengeJudge/ground_truth_phase1.jsonl`
  - dates（按天全量）: 2025-06-13
- **phase2**:
  - metadata: `../metadata_phase2.csv`
  - ground truth: `../AIOpsChallengeJudge/ground_truth_phase2.jsonl`
  - dates（按天全量）: 2025-06-27
- telemetry root: `../data`
- suite slug: `la_v10_quick_1p1c`（对应 outputs/experiments/la_v10_quick_1p1c/）

## 候选方案
- 方案D：v9 完整工程规则（metrics + logs + traces baseline 全开）（key=v9_baseline_all）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_COMPONENT_PRIOR_SCALE": "1.0", "RCA_USE_LEGACY_MEMORY": "0", "RCA_STRIP_REPLICA_SUFFIX": "0", "RCA_ENABLE_BASELINE_WINDOWS": "1", "RCA_BASELINE_GAP_MIN": "10", "RCA_BASELINE_LEN_MIN": "10", "RCA_ENABLE_FAULT_LEVEL_GATE": "1", "RCA_FAULT_LEVEL_GATE_PENALTY": "0.25", "RCA_FAULT_LEVEL_GATE_NODE_MIN_METRIC": "6.0", "RCA_FAULT_LEVEL_GATE_NODE_MIN_RATIO": "0.75", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_METRIC": "3.0", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_RATIO": "0.70", "RCA_ENABLE_NODE_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_NODE_DOMINANCE_MIN_METRIC": "5.2", "RCA_NODE_DOMINANCE_MIN_RATIO": "0.6", "RCA_NODE_DOMINANCE_MARGIN": "0.03", "RCA_ENABLE_TIDB_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_TIDB_DOMINANCE_MIN_METRIC": "2.6", "RCA_TIDB_DOMINANCE_MIN_RATIO": "0.55", "RCA_TIDB_DOMINANCE_MARGIN": "0.02", "RCA_TIDB_METRIC_SCORE_MULT": "1.8", "RCA_DISABLE_LLM": "0", "RCA_REQUIRE_LLM": "1", "RCA_LLM_PROVIDER": "deepseek", "RCA_LLM_MODEL": "deepseek-chat", "RCA_LLM_ATTEMPTS": "5", "RCA_ENABLE_BASELINE_LOGS": "1", "RCA_ENABLE_BASELINE_TRACES": "1", "RCA_ENABLE_LOG_BASELINE_CONTRAST": "1", "RCA_ENABLE_TRACE_BASELINE_CONTRAST": "1"}`
- 方案G：v10（replica hint 优先：query 提到 pod 即强制对齐）（key=v10_replica_hint_prefer）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "1", "RCA_COMPONENT_PRIOR_SCALE": "1.0", "RCA_USE_LEGACY_MEMORY": "0", "RCA_STRIP_REPLICA_SUFFIX": "0", "RCA_ENABLE_BASELINE_WINDOWS": "1", "RCA_BASELINE_GAP_MIN": "10", "RCA_BASELINE_LEN_MIN": "10", "RCA_ENABLE_FAULT_LEVEL_GATE": "1", "RCA_FAULT_LEVEL_GATE_PENALTY": "0.25", "RCA_FAULT_LEVEL_GATE_NODE_MIN_METRIC": "6.0", "RCA_FAULT_LEVEL_GATE_NODE_MIN_RATIO": "0.75", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_METRIC": "3.0", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_RATIO": "0.70", "RCA_ENABLE_NODE_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_NODE_DOMINANCE_MIN_METRIC": "5.2", "RCA_NODE_DOMINANCE_MIN_RATIO": "0.6", "RCA_NODE_DOMINANCE_MARGIN": "0.03", "RCA_ENABLE_TIDB_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_TIDB_DOMINANCE_MIN_METRIC": "2.6", "RCA_TIDB_DOMINANCE_MIN_RATIO": "0.55", "RCA_TIDB_DOMINANCE_MARGIN": "0.02", "RCA_TIDB_METRIC_SCORE_MULT": "1.8", "RCA_DISABLE_LLM": "0", "RCA_REQUIRE_LLM": "1", "RCA_LLM_PROVIDER": "deepseek", "RCA_LLM_MODEL": "deepseek-chat", "RCA_LLM_ATTEMPTS": "5", "RCA_ENABLE_BASELINE_LOGS": "1", "RCA_ENABLE_BASELINE_TRACES": "1", "RCA_ENABLE_LOG_BASELINE_CONTRAST": "1", "RCA_ENABLE_TRACE_BASELINE_CONTRAST": "1", "RCA_ENABLE_HINT_SEED": "1", "RCA_HINT_SEED_SCORE": "0.6", "RCA_HINT_BONUS": "0.8", "RCA_PREFER_REPLICA_HINTS": "1", "RCA_REPLICA_HINT_MARGIN": "0.01"}`

## 结果汇总（全部 phase 合并平均）

| 方案 | 平均LA | 平均TA | 平均Explain | 平均Eff | 平均Final |
|---|---:|---:|---:|---:|---:|
| 方案D：v9 完整工程规则（metrics + logs + traces baseline 全开） | 10.42% | 68.75% | 23.06% | 81.87% | 42.16 |
| 方案G：v10（replica hint 优先：query 提到 pod 即强制对齐） | 10.42% | 66.67% | 26.24% | 81.87% | 41.64 |

## phase1 结果汇总

| 方案 | 平均LA | 平均TA | 平均Explain | 平均Eff | 平均Final |
|---|---:|---:|---:|---:|---:|
| 方案D：v9 完整工程规则（metrics + logs + traces baseline 全开） | 8.33% | 62.50% | 17.86% | 81.87% | 38.31 |
| 方案G：v10（replica hint 优先：query 提到 pod 即强制对齐） | 8.33% | 62.50% | 28.57% | 81.87% | 39.38 |

## phase2 结果汇总

| 方案 | 平均LA | 平均TA | 平均Explain | 平均Eff | 平均Final |
|---|---:|---:|---:|---:|---:|
| 方案D：v9 完整工程规则（metrics + logs + traces baseline 全开） | 12.50% | 75.00% | 28.26% | 81.87% | 46.01 |
| 方案G：v10（replica hint 优先：query 提到 pod 即强制对齐） | 12.50% | 70.83% | 23.91% | 81.87% | 43.91 |

## 分 phase 分日期明细

| phase | date | N | 方案key | LA | TA | Explain | Eff | Final |
|---|---|---:|---|---:|---:|---:|---:|---:|
| phase1 | 2025-06-13 | 24.0 | v9_baseline_all | 8.33% | 62.50% | 17.86% | 81.87% | 38.31 |
| phase1 | 2025-06-13 | 24.0 | v10_replica_hint_prefer | 8.33% | 62.50% | 28.57% | 81.87% | 39.38 |
| phase2 | 2025-06-27 | 24.0 | v9_baseline_all | 12.50% | 75.00% | 28.26% | 81.87% | 46.01 |
| phase2 | 2025-06-27 | 24.0 | v10_replica_hint_prefer | 12.50% | 70.83% | 23.91% | 81.87% | 43.91 |

## 预测 component 分布（Top-5，按 phase）

说明：该表用于快速观察是否出现 'adservice 坍缩'（例如 Top-1 占比异常高）。

| phase | date | 方案key | Top-5 components（component:count） |
|---|---|---|---|
| phase1 | 2025-06-13 | v9_baseline_all | adservice:8; aiops-k8s-01:3; recommendationservice:2; tidb-tikv-0:2; aiops-k8s-04:2 |
| phase1 | 2025-06-13 | v10_replica_hint_prefer | adservice:8; aiops-k8s-01:3; recommendationservice:2; tidb-tikv-0:2; aiops-k8s-04:2 |
| phase2 | 2025-06-27 | v9_baseline_all | adservice:9; checkoutservice:5; emailservice:4; aiops-k8s-04:2; aiops-k8s-08:1 |
| phase2 | 2025-06-27 | v10_replica_hint_prefer | adservice:9; checkoutservice:5; emailservice:4; aiops-k8s-04:2; aiops-k8s-08:1 |

## 产物路径
- submissions: `outputs/experiments/la_v10_quick_1p1c/`
- filtered gt: `tmp/filtered/` (gt_phaseName_YYYY-MM-DD_*.jsonl)
