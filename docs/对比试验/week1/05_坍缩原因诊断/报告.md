# 坍缩原因诊断（component 向 adservice 坍缩）

目标：解释并验证为什么在 phase1（例如 2025-06-07/08）中 **LA 长期不变（≈16.67%）**，且预测 component 分布明显向 `adservice` 坍缩；并据此确定后续“直接提升 LA”的改进方向。

## 背景与核心假设

已知现象：
- 在 hints 网格中，`RCA_HINT_BONUS` 影响 Final（主要通过 TA/Explain 波动），但 **LA 完全不动**。
- 在基线误差分析中，某些日期出现明显分布坍缩（例如 `adservice=21/24`）。

因此需要重新定位坍缩来源（按优先级）：
1. **候选集问题（最可能）**：专家（Metric/Log/Trace/Graph）产出的 `Hypothesis.component` 本身就大量指向 `adservice`，导致即使关闭先验，LA 也难以改变。
2. **先验/回退问题**：当候选为空或 top score ≤ 0 时会回退到最高先验组件（可能拉向热门组件）。
3. **记忆文件 legacy 偏置**：`.aiops_memory.json` 中若存在 `component_success`（legacy success-rate），会通过 `reinforcement` 轻度放大热门组件，形成隐性偏置。
4. **权重配置问题**：`TraceSpecialist` 默认权重最高（1.6），如果 trace 证据在该数据集上更噪，可能“带偏”共识排序。

## 诊断型对比试验设计（collapse_diag_v1）

我们用最少的开关改变，做“归因型消融”，并在报告中额外输出每个方案的 **Top-5 component 预测分布**，以直接观察坍缩是否缓解。

候选方案（见脚本预设 `collapse_diag_v1`）：
- A `base_p20`：基线（对照）
- B `no_prior`：关闭 component 先验（`RCA_COMPONENT_PRIOR_SCALE=0.0`）
- C `mem_clean`：隔离记忆文件（`RCA_MEMORY_PATH=.aiops_memory.clean.json`，避免 legacy `component_success` 影响）
- D `no_prior_mem_clean`：关闭先验 + 隔离记忆
- E `trace_down`：下调 Trace 权重（`RCA_WEIGHT_TRACE=1.10`）
- F `trace_down_no_prior`：下调 Trace 权重 + 关闭先验

预期如何解读：
- 若 B 明显缓解坍缩并提升 LA：先验是主因 → 优先做先验衰减/分服务先验。
- 若 C/D 缓解：legacy 记忆在起作用 → 默认应隔离或显式关闭 legacy reward。
- 若 E/F 缓解并提升 LA：Trace 专家噪声主导 → 优先做权重重标定或 trace 证据质量门槛。
- 若上述都不动：说明“候选集本身缺 GT” → 下一步必须做候选生成改造（例如 graph/trace 反向传播、关键词→候选注入、或针对 node/edge 类 GT 的专门策略）。

## 运行命令

脚本：AIOpsChallenge_Hybrid/tools/run_final_experiment_suite.py

示例（两天全量）：
```bash
cd AIOpsChallenge_Hybrid
TOKENIZERS_PARALLELISM=false \
python tools/run_final_experiment_suite.py \
  --telemetry-root ../data \
  --metadata ../metadata_phase1.csv \
  --ground-truth ../AIOpsChallengeJudge/ground_truth_phase1.jsonl \
  --dates 2025-06-07 2025-06-08 \
  --suite-name "坍缩原因诊断" \
  --suite-slug collapse_diag_v1 \
  --preset collapse_diag_v1
```

说明：该套件会在报告中新增一节 `预测 component 分布（Top-5）`，用于快速判断是否仍然向 `adservice` 坍缩。

## 下一步（根据结果选择其一）

- 若坍缩来自候选集：增加“候选覆盖率审计”（统计 GT 是否进入 top-K 候选、被哪个 modality 压过）。
- 若坍缩来自单一 modality：增加“按 modality 输出 top-1”与“权重网格”小规模搜索。
- 若坍缩来自先验/回退：引入更安全的回退策略（例如回退到 top evidence 而非 top prior）并做消融。
