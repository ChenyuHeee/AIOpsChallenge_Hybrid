# 38_kind_aware_rerank_ab_14d

目标：在 phase1+phase2 合并数据口径下，比较多种方案对 Final（以及 LA/TA/Explainability/Efficiency）的影响。

## 试验设置
- **phase1**:
  - metadata: `/Users/hechenyu/projects/AIOPS/metadata_phase1.csv`
  - ground truth: `/Users/hechenyu/projects/AIOPS/AIOpsChallengeJudge/ground_truth_phase1.jsonl`
  - dates（按天全量）: 2025-06-13, 2025-06-07, 2025-06-11, 2025-06-08, 2025-06-10, 2025-06-09, 2025-06-14
- **phase2**:
  - metadata: `/Users/hechenyu/projects/AIOPS/metadata_phase2.csv`
  - ground truth: `/Users/hechenyu/projects/AIOPS/AIOpsChallengeJudge/ground_truth_phase2.jsonl`
  - dates（按天全量）: 2025-06-27, 2025-06-17, 2025-06-20, 2025-06-18, 2025-06-19, 2025-06-24, 2025-06-28
- telemetry root: `/Users/hechenyu/projects/AIOPS/data`
- suite slug: `38_kind_aware_rerank_ab_14d_seed7`（对应 outputs/experiments/38_kind_aware_rerank_ab_14d_seed7/）

## 候选方案
- Before：基线（fault-level gate）（key=before_baseline）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_ENABLE_HINT_SEED": "0", "RCA_COMPONENT_PRIOR_SCALE": "0.0", "RCA_USE_JUDGE_MEMORY": "0", "RCA_USE_LEGACY_MEMORY": "0", "RCA_STRIP_REPLICA_SUFFIX": "0", "RCA_ENABLE_REPLICA_EVIDENCE_PREFERENCE": "1", "RCA_ENABLE_REPLICA_CANDIDATE_PREFERENCE": "0", "RCA_PREFER_REPLICA_HINTS": "0", "RCA_ENABLE_BASELINE_WINDOWS": "1", "RCA_BASELINE_GAP_MIN": "10", "RCA_BASELINE_LEN_MIN": "10", "RCA_ENABLE_BASELINE_LOGS": "1", "RCA_ENABLE_BASELINE_TRACES": "1", "RCA_ENABLE_LOG_BASELINE_CONTRAST": "1", "RCA_ENABLE_TRACE_BASELINE_CONTRAST": "1", "RCA_ENABLE_FAULT_LEVEL_GATE": "1", "RCA_FAULT_LEVEL_GATE_PENALTY": "0.25", "RCA_FAULT_LEVEL_GATE_NODE_MIN_METRIC": "6.0", "RCA_FAULT_LEVEL_GATE_NODE_MIN_RATIO": "0.75", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_METRIC": "3.0", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_RATIO": "0.70", "RCA_ENABLE_NODE_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_NODE_DOMINANCE_MIN_METRIC": "5.2", "RCA_NODE_DOMINANCE_MIN_RATIO": "0.6", "RCA_NODE_DOMINANCE_MARGIN": "0.03", "RCA_ENABLE_TIDB_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_TIDB_DOMINANCE_MIN_METRIC": "2.6", "RCA_TIDB_DOMINANCE_MIN_RATIO": "0.55", "RCA_TIDB_DOMINANCE_MARGIN": "0.02", "RCA_TIDB_METRIC_SCORE_MULT": "1.8", "RCA_ENABLE_NODE_BOOST": "0", "RCA_ENABLE_NODE_STRONG_OVERRIDE": "0", "RCA_DISABLE_LLM": "1", "RCA_REQUIRE_LLM": "0"}`
- After：kind-aware rerank（两段式）（key=after_kind_aware_rerank）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_ENABLE_HINT_SEED": "0", "RCA_COMPONENT_PRIOR_SCALE": "0.0", "RCA_USE_JUDGE_MEMORY": "0", "RCA_USE_LEGACY_MEMORY": "0", "RCA_STRIP_REPLICA_SUFFIX": "0", "RCA_ENABLE_REPLICA_EVIDENCE_PREFERENCE": "1", "RCA_ENABLE_REPLICA_CANDIDATE_PREFERENCE": "0", "RCA_PREFER_REPLICA_HINTS": "0", "RCA_ENABLE_BASELINE_WINDOWS": "1", "RCA_BASELINE_GAP_MIN": "10", "RCA_BASELINE_LEN_MIN": "10", "RCA_ENABLE_BASELINE_LOGS": "1", "RCA_ENABLE_BASELINE_TRACES": "1", "RCA_ENABLE_LOG_BASELINE_CONTRAST": "1", "RCA_ENABLE_TRACE_BASELINE_CONTRAST": "1", "RCA_ENABLE_FAULT_LEVEL_GATE": "1", "RCA_FAULT_LEVEL_GATE_PENALTY": "0.25", "RCA_FAULT_LEVEL_GATE_NODE_MIN_METRIC": "6.0", "RCA_FAULT_LEVEL_GATE_NODE_MIN_RATIO": "0.75", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_METRIC": "3.0", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_RATIO": "0.70", "RCA_ENABLE_NODE_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_NODE_DOMINANCE_MIN_METRIC": "5.2", "RCA_NODE_DOMINANCE_MIN_RATIO": "0.6", "RCA_NODE_DOMINANCE_MARGIN": "0.03", "RCA_ENABLE_TIDB_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_TIDB_DOMINANCE_MIN_METRIC": "2.6", "RCA_TIDB_DOMINANCE_MIN_RATIO": "0.55", "RCA_TIDB_DOMINANCE_MARGIN": "0.02", "RCA_TIDB_METRIC_SCORE_MULT": "1.8", "RCA_ENABLE_NODE_BOOST": "0", "RCA_ENABLE_NODE_STRONG_OVERRIDE": "0", "RCA_DISABLE_LLM": "1", "RCA_REQUIRE_LLM": "0", "RCA_ENABLE_KIND_AWARE_RERANK": "1", "RCA_KIND_RERANK_PENALTY": "0.30", "RCA_KIND_RERANK_NODE_MIN_METRIC": "6.0", "RCA_KIND_RERANK_NODE_STRONG_METRIC": "8.0", "RCA_KIND_RERANK_NODE_MIN_RATIO": "0.82", "RCA_KIND_RERANK_NODE_REQUIRE_TRACES": "1", "RCA_KIND_RERANK_PENALIZE_NO_EVIDENCE": "1", "RCA_KIND_RERANK_NO_EVIDENCE_FACTOR": "0.55", "RCA_KIND_RERANK_TIDB_MIN_METRIC": "3.0", "RCA_KIND_RERANK_TIDB_MIN_RATIO": "0.72", "RCA_KIND_RERANK_BLOCK_ON_REPLICA_LOG": "1", "RCA_KIND_RERANK_REPLICA_LOG_BLOCK_RATIO": "0.55", "RCA_KIND_RERANK_REPLICA_LOG_BLOCK_SCORE": "2.2"}`

## 结果汇总（全部 phase 合并平均）

| 方案 | 平均LA | 平均TA | 平均Explain | 平均Eff | 平均Final |
|---|---:|---:|---:|---:|---:|
| Before：基线（fault-level gate） | 14.08% | 54.47% | 23.19% | 81.87% | 37.93 |
| After：kind-aware rerank（两段式） | 16.91% | 56.70% | 22.86% | 81.87% | 39.92 |

## phase1 结果汇总

| 方案 | 平均LA | 平均TA | 平均Explain | 平均Eff | 平均Final |
|---|---:|---:|---:|---:|---:|
| Before：基线（fault-level gate） | 16.25% | 54.18% | 21.77% | 81.87% | 38.54 |
| After：kind-aware rerank（两段式） | 16.25% | 54.18% | 21.77% | 81.87% | 38.54 |

## phase2 结果汇总

| 方案 | 平均LA | 平均TA | 平均Explain | 平均Eff | 平均Final |
|---|---:|---:|---:|---:|---:|
| Before：基线（fault-level gate） | 11.90% | 54.76% | 24.61% | 81.87% | 37.32 |
| After：kind-aware rerank（两段式） | 17.56% | 59.23% | 23.95% | 81.87% | 41.30 |

## 分 phase 分日期明细

| phase | date | N | 方案key | LA | TA | Explain | Eff | Final |
|---|---|---:|---|---:|---:|---:|---:|---:|
| phase1 | 2025-06-13 | 24.0 | before_baseline | 8.33% | 54.17% | 21.43% | 81.87% | 35.33 |
| phase1 | 2025-06-13 | 24.0 | after_kind_aware_rerank | 8.33% | 54.17% | 21.43% | 81.87% | 35.33 |
| phase1 | 2025-06-07 | 24.0 | before_baseline | 25.00% | 66.67% | 28.26% | 81.87% | 47.68 |
| phase1 | 2025-06-07 | 24.0 | after_kind_aware_rerank | 25.00% | 66.67% | 28.26% | 81.87% | 47.68 |
| phase1 | 2025-06-11 | 24.0 | before_baseline | 12.50% | 45.83% | 19.57% | 81.87% | 33.48 |
| phase1 | 2025-06-11 | 24.0 | after_kind_aware_rerank | 12.50% | 45.83% | 19.57% | 81.87% | 33.48 |
| phase1 | 2025-06-08 | 24.0 | before_baseline | 8.33% | 29.17% | 7.41% | 81.87% | 23.93 |
| phase1 | 2025-06-08 | 24.0 | after_kind_aware_rerank | 8.33% | 29.17% | 7.41% | 81.87% | 23.93 |
| phase1 | 2025-06-10 | 24.0 | before_baseline | 16.67% | 50.00% | 20.00% | 81.87% | 36.85 |
| phase1 | 2025-06-10 | 24.0 | after_kind_aware_rerank | 16.67% | 50.00% | 20.00% | 81.87% | 36.85 |
| phase1 | 2025-06-09 | 23.0 | before_baseline | 30.43% | 52.17% | 25.71% | 81.87% | 43.80 |
| phase1 | 2025-06-09 | 23.0 | after_kind_aware_rerank | 30.43% | 52.17% | 25.71% | 81.87% | 43.80 |
| phase1 | 2025-06-14 | 16.0 | before_baseline | 12.50% | 81.25% | 30.00% | 81.87% | 48.69 |
| phase1 | 2025-06-14 | 16.0 | after_kind_aware_rerank | 12.50% | 81.25% | 30.00% | 81.87% | 48.69 |
| phase2 | 2025-06-27 | 24.0 | before_baseline | 8.33% | 54.17% | 32.61% | 81.87% | 36.45 |
| phase2 | 2025-06-27 | 24.0 | after_kind_aware_rerank | 16.67% | 54.17% | 32.61% | 81.87% | 39.78 |
| phase2 | 2025-06-17 | 24.0 | before_baseline | 25.00% | 45.83% | 20.93% | 81.87% | 38.61 |
| phase2 | 2025-06-17 | 24.0 | after_kind_aware_rerank | 20.83% | 50.00% | 16.28% | 81.87% | 38.15 |
| phase2 | 2025-06-20 | 24.0 | before_baseline | 4.17% | 50.00% | 26.42% | 81.87% | 32.50 |
| phase2 | 2025-06-20 | 24.0 | after_kind_aware_rerank | 4.17% | 50.00% | 26.42% | 81.87% | 32.50 |
| phase2 | 2025-06-18 | 24.0 | before_baseline | 8.33% | 50.00% | 14.00% | 81.87% | 32.92 |
| phase2 | 2025-06-18 | 24.0 | after_kind_aware_rerank | 20.83% | 66.67% | 14.00% | 81.87% | 44.59 |
| phase2 | 2025-06-19 | 24.0 | before_baseline | 12.50% | 58.33% | 23.64% | 81.87% | 38.88 |
| phase2 | 2025-06-19 | 24.0 | after_kind_aware_rerank | 16.67% | 62.50% | 23.64% | 81.87% | 42.22 |
| phase2 | 2025-06-24 | 16.0 | before_baseline | 12.50% | 68.75% | 36.84% | 81.87% | 44.37 |
| phase2 | 2025-06-24 | 16.0 | after_kind_aware_rerank | 12.50% | 68.75% | 36.84% | 81.87% | 44.37 |
| phase2 | 2025-06-28 | 16.0 | before_baseline | 12.50% | 56.25% | 17.86% | 81.87% | 37.47 |
| phase2 | 2025-06-28 | 16.0 | after_kind_aware_rerank | 31.25% | 62.50% | 17.86% | 81.87% | 47.47 |

## 预测 component 分布（Top-5，按 phase）

说明：该表用于快速观察是否出现 'adservice 坍缩'（例如 Top-1 占比异常高）。

| phase | date | 方案key | Top-5 components（component:count） |
|---|---|---|---|
| phase1 | 2025-06-13 | before_baseline | adservice:7; aiops-k8s-04:3; adservice-0:2; emailservice:2; frontend:2 |
| phase1 | 2025-06-13 | after_kind_aware_rerank | adservice:7; aiops-k8s-04:3; adservice-0:2; emailservice:2; frontend:2 |
| phase1 | 2025-06-07 | before_baseline | adservice:7; aiops-k8s-03:4; checkoutservice-2:3; aiops-k8s-07:2; emailservice:2 |
| phase1 | 2025-06-07 | after_kind_aware_rerank | adservice:7; aiops-k8s-03:4; checkoutservice-2:3; aiops-k8s-07:2; emailservice:2 |
| phase1 | 2025-06-11 | before_baseline | adservice:7; emailservice:3; checkoutservice-1:2; shippingservice:2; cartservice:1 |
| phase1 | 2025-06-11 | after_kind_aware_rerank | adservice:7; emailservice:3; checkoutservice-1:2; shippingservice:2; cartservice:1 |
| phase1 | 2025-06-08 | before_baseline | adservice:7; aiops-k8s-08:4; emailservice:3; aiops-k8s-07:3; aiops-k8s-04:2 |
| phase1 | 2025-06-08 | after_kind_aware_rerank | adservice:7; aiops-k8s-08:4; emailservice:3; aiops-k8s-07:3; aiops-k8s-04:2 |
| phase1 | 2025-06-10 | before_baseline | adservice:9; aiops-k8s-04:4; aiops-k8s-03:3; emailservice:2; frontend:2 |
| phase1 | 2025-06-10 | after_kind_aware_rerank | adservice:9; aiops-k8s-04:4; aiops-k8s-03:3; emailservice:2; frontend:2 |
| phase1 | 2025-06-09 | before_baseline | adservice:6; emailservice:3; aiops-k8s-08:2; aiops-k8s-03:2; frontend:1 |
| phase1 | 2025-06-09 | after_kind_aware_rerank | adservice:6; emailservice:3; aiops-k8s-08:2; aiops-k8s-03:2; frontend:1 |
| phase1 | 2025-06-14 | before_baseline | aiops-k8s-04:2; checkoutservice-0:2; cartservice:1; aiops-k8s-07:1; aiops-k8s-06:1 |
| phase1 | 2025-06-14 | after_kind_aware_rerank | aiops-k8s-04:2; checkoutservice-0:2; cartservice:1; aiops-k8s-07:1; aiops-k8s-06:1 |
| phase2 | 2025-06-27 | before_baseline | adservice:7; checkoutservice-0:4; aiops-k8s-08:2; emailservice:2; aiops-k8s-05:2 |
| phase2 | 2025-06-27 | after_kind_aware_rerank | adservice:7; checkoutservice-0:4; tidb-tidb-0:3; tidb-tikv-0:2; emailservice:2 |
| phase2 | 2025-06-17 | before_baseline | adservice:7; aiops-k8s-06:4; aiops-k8s-05:3; aiops-k8s-08:2; aiops-k8s-07:2 |
| phase2 | 2025-06-17 | after_kind_aware_rerank | adservice:7; tidb-tikv-0:6; tidb-tidb-0:3; frontend:1; checkoutservice-2:1 |
| phase2 | 2025-06-20 | before_baseline | adservice:7; aiops-k8s-08:3; tidb-tikv-0:2; emailservice:2; currencyservice:1 |
| phase2 | 2025-06-20 | after_kind_aware_rerank | adservice:7; aiops-k8s-08:3; tidb-tikv-0:2; emailservice:2; currencyservice:1 |
| phase2 | 2025-06-18 | before_baseline | adservice:7; aiops-k8s-04:3; aiops-k8s-08:2; hipstershop:1; checkoutservice-0:1 |
| phase2 | 2025-06-18 | after_kind_aware_rerank | adservice:7; tidb-tikv-0:5; tidb-tidb-0:2; hipstershop:1; checkoutservice-0:1 |
| phase2 | 2025-06-19 | before_baseline | adservice:7; aiops-k8s-04:3; productcatalogservice-0:3; checkoutservice-2:2; cartservice:2 |
| phase2 | 2025-06-19 | after_kind_aware_rerank | adservice:7; productcatalogservice-0:3; tidb-tikv-0:2; checkoutservice-2:2; aiops-k8s-04:2 |
| phase2 | 2025-06-24 | before_baseline | aiops-k8s-08:3; aiops-k8s-04:2; shippingservice:1; aiops-k8s-06:1; frontend-1:1 |
| phase2 | 2025-06-24 | after_kind_aware_rerank | tidb-tikv-0:2; aiops-k8s-04:2; shippingservice:1; aiops-k8s-06:1; frontend-1:1 |
| phase2 | 2025-06-28 | before_baseline | aiops-k8s-04:4; aiops-k8s-08:2; emailservice:2; tidb-tikv-0:1; cartservice:1 |
| phase2 | 2025-06-28 | after_kind_aware_rerank | tidb-tikv-0:5; aiops-k8s-04:2; emailservice:2; aiops-k8s-08:1; tidb-tidb-0:1 |

## 产物路径
- submissions: `outputs/experiments/38_kind_aware_rerank_ab_14d_seed7/`
- filtered gt: `tmp/filtered/` (gt_phaseName_YYYY-MM-DD_*.jsonl)
