# 37_evidence_probe_hybrid

目标：用最少的 ablation 组，定位“GT 证据问题”出现在哪一环：
- 单模态证据是否足够把 GT 推高（metrics/logs/traces/graph）
- 融合/工程规则（fault-level gate、node/TiDB dominance 等）是否压制/帮助 GT
- type arbiter（postcheck）是否会把本来正确的 top1 翻走

说明：评测中 GT 的 `A->B` 会被拆成 `[A,B]`，命中任一端即算 component_correct；但仍要求 **完全相等**（例如 `frontend-0` 不等于 `frontend`）。

## 试验设置
- **phase1**: metadata=../metadata_phase1.csv; gt=../AIOpsChallengeJudge/ground_truth_phase1.jsonl; dates=2025-06-13, 2025-06-14, 2025-06-07
- **phase2**: metadata=../metadata_phase2.csv; gt=../AIOpsChallengeJudge/ground_truth_phase2.jsonl; dates=2025-06-27, 2025-06-28, 2025-06-24
- suite slug: `37_evidence_probe_hybrid_p1p2_6d`（对应 outputs/experiments/37_evidence_probe_hybrid_p1p2_6d/）

## 候选方案
- E0：融合基线（当前v9规则；无type arbiter）（key=e0_fusion_baseline）
- E1：融合但禁用 infra 规则（无 dominance / 无 gate）（key=e1_fusion_no_infra_rules）
- E2：仅 metrics 证据（权重置零其余模态）（key=e2_metric_only）
- E3：仅 logs 证据（权重置零其余模态）（key=e3_log_only）
- E4：仅 traces 证据（权重置零其余模态）（key=e4_trace_only）
- E5：仅 graph 证据（权重置零其余模态）（key=e5_graph_only）
- E6：规则 type arbiter（postcheck，对照是否“翻走”）（key=e6_rule_arbiter_postcheck）

## 结果汇总（全部 phase 合并；严格按 judge 累计计算）

| 方案 | 样本数N | LA | TA | Explain | Eff | Final |
|---|---:|---:|---:|---:|---:|---:|
| E0：融合基线（当前v9规则；无type arbiter） | 120 | 13.33% | 44.17% | 14.21% | 81.87% | 32.61 |
| E1：融合但禁用 infra 规则（无 dominance / 无 gate） | 120 | 4.17% | 47.50% | 28.43% | 81.87% | 31.70 |
| E2：仅 metrics 证据（权重置零其余模态） | 120 | 8.33% | 42.50% | 3.55% | 81.87% | 28.88 |
| E3：仅 logs 证据（权重置零其余模态） | 120 | 5.00% | 50.83% | 3.55% | 81.87% | 30.88 |
| E4：仅 traces 证据（权重置零其余模态） | 120 | 6.67% | 60.00% | 38.58% | 81.87% | 38.71 |
| E5：仅 graph 证据（权重置零其余模态） | 120 | 5.83% | 46.67% | 3.55% | 81.87% | 29.54 |
| E6：规则 type arbiter（postcheck，对照是否“翻走”） | 120 | 13.33% | 48.33% | 21.83% | 81.87% | 35.04 |

## 证据定位统计（基于 debug.consensus_topk；topK=80）

解释：
- **GT-in-topK**：GT（按 judge 的 parts 语义，`A->B` 视为 A/B 任一端）是否出现在 debug 的 `consensus_topk` 中
- **best-rank**：GT 在 `consensus_topk` 中出现时的最优名次（越小越好）
- **top1_is_gt**：共识 top1 是否命中 GT（在本试验中，由于 `RCA_COMPONENT_SOURCE=consensus`，基本等价于 LA）

| 方案key | LA | GT-in-topK | best-rank(p50) | best-rank(p90) | top1_is_gt | “top1=GT但输出≠GT” |
|---|---:|---:|---:|---:|---:|---:|
| e0_fusion_baseline | 13.33% | 70.00% | 12 | 33 | 13.33% | 0 |
| e1_fusion_no_infra_rules | 4.17% | 70.00% | 14 | 33 | 4.17% | 0 |
| e2_metric_only | 8.33% | 70.00% | 11 | 35 | 8.33% | 0 |
| e3_log_only | 5.00% | 68.33% | 12 | 46 | 5.00% | 0 |
| e4_trace_only | 6.67% | 68.33% | 15 | 50 | 6.67% | 0 |
| e5_graph_only | 5.83% | 68.33% | 11 | 46 | 5.83% | 0 |
| e6_rule_arbiter_postcheck | 13.33% | 70.00% | 12 | 33 | 13.33% | 0 |

初步结论（针对本次 6 天样本）：
- **不是纯召回缺失**：各方案 GT-in-top80 约 68%~70%，说明不少 case 的 GT 是“在候选集里”的。
- **更像排序/融合问题**：best-rank 的中位数约 11~15、p90 到 33~50，意味着 GT 经常被排在较后位置，难以成为 top1。
- **infra 规则整体在“帮忙”而不是压制**：E0（带 gate+dominance）LA=13.33% 显著高于 E1（去规则）LA=4.17%。
- **本次未观测到 postcheck 翻车**：E6 与 E0 的 LA 相同，且统计中“top1=GT但输出≠GT”为 0（规则仲裁未把已命中的 top1 翻走）。

## 跨 phase 分日期证据对照（不区分 phase；E0 vs E1）

说明：这里不再按 phase 拆分，只按 **日期** 聚合（本次 6 个日期刚好各自只出现于某一 phase，但分析视角按“同一套机制在不同天”来对照）。

| 日期 | N | E0_LA | E1_LA | ΔLA | E0_top1=GT | E1_top1=GT | E0_GT_in_top80 | E1_GT_in_top80 | E0_rank_p50/p90 | E1_rank_p50/p90 |
|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| 2025-06-07 | 24 | 20.83% | 16.67% | 4.17% | 20.83% | 16.67% | 66.67% | 66.67% | 8/15 | 8/15 |
| 2025-06-13 | 24 | 4.17% | 0.00% | 4.17% | 4.17% | 0.00% | 58.33% | 58.33% | 17/42 | 17/42 |
| 2025-06-14 | 16 | 12.50% | 0.00% | 12.50% | 12.50% | 0.00% | 87.50% | 87.50% | 15/38 | 15/38 |
| 2025-06-24 | 16 | 6.25% | 0.00% | 6.25% | 6.25% | 0.00% | 81.25% | 81.25% | 11/22 | 13/22 |
| 2025-06-27 | 24 | 12.50% | 0.00% | 12.50% | 12.50% | 0.00% | 58.33% | 58.33% | 9/18 | 13/18 |
| 2025-06-28 | 16 | 25.00% | 6.25% | 18.75% | 25.00% | 6.25% | 81.25% | 81.25% | 15/26 | 17/26 |

解读要点：
- **E0→E1 的损失主要来自“top1 不再是 GT”**：两者 GT-in-top80 与 best-rank 分布接近，但 E1 在 4/6 天里 top1=GT 直接掉到 0%。
- **E0 命中但 E1 未命中的 case 数量明显更多**：全 120 个样本里，统计到 **E0 命中但 E1 未命中=12**；反向（E1 命中但 E0 未命中）仅 **1**。
- 代表性现象（样例）：当 GT 是 node（如 `aiops-k8s-05/06/08`）时，E1 更容易把 top1 选成某个 service（如 `cartservice`、`emailservice`），而 E0 通过 dominance/gate 把 node 类候选推到 top1，从而拿到 LA。

这组对照更倾向于说明：**当前“infra 规则”在少数关键样本上承担了“把 GT 从非 top1 推到 top1”的职责**；而多数样本的瓶颈仍是“GT 排名整体靠后（best-rank p50 约 9~17）”。

## Top1 竞争对手剖析（用于指导下一步优化）

统计口径：只看 **GT 在 top80 但未命中** 的样本（也就是“证据在候选里，但没被选成 top1”）。

### E0：融合基线（带 gate+dominance）

- N=120，LA=13.33%，GT-in-top80=70.00%
- **GT 在 top80 但未命中 = 68**（这是当前主要损失桶）

Top1 最常见竞争对手（Top 5）：

| 排名 | top1 组件 | 次数 | 占比 |
|---:|---|---:|---:|
| 1 | aiops-k8s-05 | 10 | 14.71% |
| 2 | aiops-k8s-03 | 7 | 10.29% |
| 3 | aiops-k8s-04 | 6 | 8.82% |
| 4 | tidb-tidb-0 | 6 | 8.82% |
| 5 | aiops-k8s-07 | 6 | 8.82% |

GT_kind vs top1_kind（Top 4）：

| GT_kind | top1_kind | 次数 | 占比 |
|---|---|---:|---:|
| service | node | 33 | 48.53% |
| service | service | 13 | 19.12% |
| tidb | node | 8 | 11.76% |
| service | tidb | 7 | 10.29% |

解释：E0 的失败模式偏向 **“过度押注 infra（node/tidb）导致 service GT 被 node 顶掉”**。

### E1：融合但禁用 infra 规则（无 dominance / 无 gate）

- N=120，LA=4.17%，GT-in-top80=70.00%
- **GT 在 top80 但未命中 = 79**（比 E0 多 11 个）

Top1 最常见竞争对手（Top 5）：

| 排名 | top1 组件 | 次数 | 占比 |
|---:|---|---:|---:|
| 1 | cartservice | 21 | 26.58% |
| 2 | emailservice | 14 | 17.72% |
| 3 | frontend-1 | 7 | 8.86% |
| 4 | frontend-2 | 6 | 7.59% |
| 5 | aiops-k8s-04 | 6 | 7.59% |

GT_kind vs top1_kind（Top 4）：

| GT_kind | top1_kind | 次数 | 占比 |
|---|---|---:|---:|
| service | service | 40 | 50.63% |
| tidb | service | 14 | 17.72% |
| node | service | 11 | 13.92% |
| service | node | 9 | 11.39% |

解释：E1 的失败模式偏向 **“service 互相混淆 + node/tidb 也被 service 顶掉”**，并且 top1 频繁落在少数热门服务（cartservice/emailservice/frontend）上。

### 直接推导出的优化方向（下一步怎么改）

从 E0/E1 的对照看，核心不是“GT 是否入池”，而是 **“infra vs service 的 rerank 策略”**：

- 需要保留 infra 规则的“救命能力”（E0 相比 E1 明显更能把 node 类推到 top1）。
- 同时需要抑制 E0 的副作用：当 GT 更像 service 时，避免 node dominance 抢走 top1。

因此下一步改动建议是做 **kind-aware rerank（两段式）**：

1) 先做一个粗分：本案更像 infra 还是 service（可用 node_metric_max / tidb_metric_max 的强度、以及 logs/traces 是否集中在某个 service 来判别）。
2) 在各自赛道内做 rerank：
	- 若判为 infra：保留 dominance；service 候选需要更强的 log/trace 支持才能赢。
	- 若判为 service：降低/关闭 dominance，让 service 之间用 logs/traces 主导排序。

## phase1 结果汇总（该 phase 合并；严格按 judge 累计计算）

| 方案 | 样本数N | LA | TA | Explain | Eff | Final |
|---|---:|---:|---:|---:|---:|---:|
| E0：融合基线（当前v9规则；无type arbiter） | 64 | 12.50% | 40.62% | 17.31% | 81.87% | 31.17 |
| E1：融合但禁用 infra 规则（无 dominance / 无 gate） | 64 | 6.25% | 48.44% | 26.92% | 81.87% | 32.75 |
| E2：仅 metrics 证据（权重置零其余模态） | 64 | 7.81% | 43.75% | 4.81% | 81.87% | 29.29 |
| E3：仅 logs 证据（权重置零其余模态） | 64 | 6.25% | 51.56% | 4.81% | 81.87% | 31.79 |
| E4：仅 traces 证据（权重置零其余模态） | 64 | 9.38% | 54.69% | 29.81% | 81.87% | 36.79 |
| E5：仅 graph 证据（权重置零其余模态） | 64 | 7.81% | 45.31% | 4.81% | 81.87% | 29.92 |
| E6：规则 type arbiter（postcheck，对照是否“翻走”） | 64 | 12.50% | 45.31% | 24.04% | 81.87% | 33.72 |

## phase2 结果汇总（该 phase 合并；严格按 judge 累计计算）

| 方案 | 样本数N | LA | TA | Explain | Eff | Final |
|---|---:|---:|---:|---:|---:|---:|
| E0：融合基线（当前v9规则；无type arbiter） | 56 | 14.29% | 48.21% | 10.75% | 81.87% | 34.26 |
| E1：融合但禁用 infra 规则（无 dominance / 无 gate） | 56 | 1.79% | 46.43% | 30.11% | 81.87% | 30.48 |
| E2：仅 metrics 证据（权重置零其余模态） | 56 | 8.93% | 41.07% | 2.15% | 81.87% | 28.40 |
| E3：仅 logs 证据（权重置零其余模态） | 56 | 3.57% | 50.00% | 2.15% | 81.87% | 29.83 |
| E4：仅 traces 证据（权重置零其余模态） | 56 | 3.57% | 66.07% | 48.39% | 81.87% | 40.88 |
| E5：仅 graph 证据（权重置零其余模态） | 56 | 3.57% | 48.21% | 2.15% | 81.87% | 29.12 |
| E6：规则 type arbiter（postcheck，对照是否“翻走”） | 56 | 14.29% | 51.79% | 19.35% | 81.87% | 36.55 |

## LA 丢分点分析（组件命中）

为避免报告过长，本节仅对 **Final 最优** 的方案（E4：仅 traces 证据（权重置零其余模态），key=e4_trace_only）做错因分解。

- 样本数 N=120，原始 LA=6.67%（命中 8/120）
- 命名后缀归一化（仅用于解释，不改变 judge 规则）可带来的理论上限：约 11.67%
- 纯后缀错配计数：GT 为 `*-0` 但预测 base（可选 pod 才能修复）=1；预测为 `*-0` 但 GT 为 base（可通过 strip 修复）=3

| 类别 | 计数 | 解释 |
|---|---:|---|
| HIT | 8 | 预测 component 与 GT parts 任一端完全相等 |
| GT_NODE__PRED_SERVICE | 50 | GT 是 node/TiDB，预测成服务 |
| GT_SERVICE__PRED_NODE | 1 | GT 是服务，预测成 node/TiDB |
| SAME_KIND_BUT_WRONG | 61 | 同类型但选错对象（服务/节点内互相混淆） |

Top 混淆对（GT -> Pred，按出现次数）
| 次数 | GT | Pred |
|---:|---|---|
| 5 | tidb-tikv-0 | checkoutservice-0 |
| 3 | adservice-0 | checkoutservice-0 |
| 3 | aiops-k8s-08 | checkoutservice-0 |
| 3 | tidb-tikv-0 | checkoutservice-1 |
| 2 | recommendationservice | checkoutservice-0 |
| 2 | shippingservice-0 | adservice |
| 2 | aiops-k8s-06 | adservice |
| 2 | tidb-tikv-0 | frontend-0 |
| 2 | tidb-tikv-0 | adservice |
| 2 | tidb-tikv-0 | frontend-2 |

## 分 phase 分日期明细

| phase | date | N | 方案key | LA | TA | Explain | Eff | Final |
|---|---|---:|---|---:|---:|---:|---:|---:|
| phase1 | 2025-06-13 | 24 | e0_fusion_baseline | 4.17% | 25.00% | 7.14% | 81.87% | 20.57 |
| phase1 | 2025-06-13 | 24 | e1_fusion_no_infra_rules | 0.00% | 37.50% | 14.29% | 0.00% | 16.43 |
| phase1 | 2025-06-13 | 24 | e2_metric_only | 0.00% | 33.33% | 7.14% | 0.00% | 14.05 |
| phase1 | 2025-06-13 | 24 | e3_log_only | 8.33% | 37.50% | 3.57% | 81.87% | 26.88 |
| phase1 | 2025-06-13 | 24 | e4_trace_only | 4.17% | 45.83% | 14.29% | 81.87% | 29.62 |
| phase1 | 2025-06-13 | 24 | e5_graph_only | 8.33% | 33.33% | 3.57% | 81.87% | 25.21 |
| phase1 | 2025-06-13 | 24 | e6_rule_arbiter_postcheck | 4.17% | 33.33% | 10.71% | 81.87% | 24.26 |
| phase1 | 2025-06-14 | 16 | e0_fusion_baseline | 12.50% | 50.00% | 23.33% | 81.87% | 35.52 |
| phase1 | 2025-06-14 | 16 | e1_fusion_no_infra_rules | 0.00% | 62.50% | 23.33% | 0.00% | 27.33 |
| phase1 | 2025-06-14 | 16 | e2_metric_only | 12.50% | 56.25% | 6.67% | 81.87% | 36.35 |
| phase1 | 2025-06-14 | 16 | e3_log_only | 0.00% | 75.00% | 10.00% | 0.00% | 31.00 |
| phase1 | 2025-06-14 | 16 | e4_trace_only | 6.25% | 75.00% | 30.00% | 81.87% | 43.69 |
| phase1 | 2025-06-14 | 16 | e5_graph_only | 6.25% | 68.75% | 10.00% | 81.87% | 39.19 |
| phase1 | 2025-06-14 | 16 | e6_rule_arbiter_postcheck | 12.50% | 62.50% | 30.00% | 81.87% | 41.19 |
| phase1 | 2025-06-07 | 24 | e0_fusion_baseline | 20.83% | 50.00% | 19.57% | 81.87% | 38.48 |
| phase1 | 2025-06-07 | 24 | e1_fusion_no_infra_rules | 16.67% | 50.00% | 36.96% | 81.87% | 38.55 |
| phase1 | 2025-06-07 | 24 | e2_metric_only | 12.50% | 45.83% | 2.17% | 81.87% | 31.74 |
| phase1 | 2025-06-07 | 24 | e3_log_only | 8.33% | 50.00% | 2.17% | 81.87% | 31.74 |
| phase1 | 2025-06-07 | 24 | e4_trace_only | 16.67% | 50.00% | 39.13% | 81.87% | 38.77 |
| phase1 | 2025-06-07 | 24 | e5_graph_only | 8.33% | 41.67% | 2.17% | 81.87% | 28.40 |
| phase1 | 2025-06-07 | 24 | e6_rule_arbiter_postcheck | 20.83% | 45.83% | 28.26% | 81.87% | 37.68 |
| phase2 | 2025-06-27 | 24 | e0_fusion_baseline | 12.50% | 41.67% | 8.70% | 81.87% | 30.72 |
| phase2 | 2025-06-27 | 24 | e1_fusion_no_infra_rules | 0.00% | 41.67% | 26.09% | 0.00% | 19.28 |
| phase2 | 2025-06-27 | 24 | e2_metric_only | 0.00% | 29.17% | 0.00% | 0.00% | 11.67 |
| phase2 | 2025-06-27 | 24 | e3_log_only | 0.00% | 33.33% | 0.00% | 0.00% | 13.33 |
| phase2 | 2025-06-27 | 24 | e4_trace_only | 8.33% | 54.17% | 43.48% | 81.87% | 37.54 |
| phase2 | 2025-06-27 | 24 | e5_graph_only | 0.00% | 33.33% | 0.00% | 0.00% | 13.33 |
| phase2 | 2025-06-27 | 24 | e6_rule_arbiter_postcheck | 12.50% | 45.83% | 17.39% | 81.87% | 33.26 |
| phase2 | 2025-06-28 | 16 | e0_fusion_baseline | 25.00% | 50.00% | 3.57% | 81.87% | 38.54 |
| phase2 | 2025-06-28 | 16 | e1_fusion_no_infra_rules | 6.25% | 50.00% | 32.14% | 81.87% | 33.90 |
| phase2 | 2025-06-28 | 16 | e2_metric_only | 12.50% | 31.25% | 3.57% | 81.87% | 26.04 |
| phase2 | 2025-06-28 | 16 | e3_log_only | 0.00% | 56.25% | 3.57% | 0.00% | 22.86 |
| phase2 | 2025-06-28 | 16 | e4_trace_only | 0.00% | 81.25% | 46.43% | 0.00% | 37.14 |
| phase2 | 2025-06-28 | 16 | e5_graph_only | 0.00% | 56.25% | 3.57% | 0.00% | 22.86 |
| phase2 | 2025-06-28 | 16 | e6_rule_arbiter_postcheck | 25.00% | 56.25% | 17.86% | 81.87% | 42.47 |
| phase2 | 2025-06-24 | 16 | e0_fusion_baseline | 6.25% | 56.25% | 26.32% | 81.87% | 35.82 |
| phase2 | 2025-06-24 | 16 | e1_fusion_no_infra_rules | 0.00% | 50.00% | 36.84% | 0.00% | 23.68 |
| phase2 | 2025-06-24 | 16 | e2_metric_only | 18.75% | 68.75% | 5.26% | 81.87% | 43.71 |
| phase2 | 2025-06-24 | 16 | e3_log_only | 12.50% | 68.75% | 5.26% | 81.87% | 41.21 |
| phase2 | 2025-06-24 | 16 | e4_trace_only | 0.00% | 68.75% | 63.16% | 0.00% | 33.82 |
| phase2 | 2025-06-24 | 16 | e5_graph_only | 12.50% | 62.50% | 5.26% | 81.87% | 38.71 |
| phase2 | 2025-06-24 | 16 | e6_rule_arbiter_postcheck | 6.25% | 56.25% | 26.32% | 81.87% | 35.82 |
