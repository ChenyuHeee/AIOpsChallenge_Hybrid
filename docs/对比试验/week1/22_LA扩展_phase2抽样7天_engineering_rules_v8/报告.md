# 22_LA扩展_phase2抽样7天_engineering_rules_v8

目标：在固定数据口径下，比较多种方案对 Final（以及 LA/TA/Explainability/Efficiency）的影响。

## 试验设置
- metadata: `metadata_phase2.csv`
- ground truth: `AIOpsChallengeJudge/ground_truth_phase2.jsonl`
- telemetry root: `/Users/hechenyu/projects/AIOPS/data`
- dates（按天全量）: 2025-06-27, 2025-06-17, 2025-06-20, 2025-06-18, 2025-06-19, 2025-06-24, 2025-06-28
- suite slug: `la_v8_engineering_rules_p2_seed7`（对应 outputs/experiments/la_v8_engineering_rules_p2_seed7/）

## 候选方案
- 方案A：对照（v7: node/tidb dominance；baseline/fault_level 关闭）（key=base_safe）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_COMPONENT_PRIOR_SCALE": "1.0", "RCA_USE_LEGACY_MEMORY": "0", "RCA_STRIP_REPLICA_SUFFIX": "0", "RCA_ENABLE_BASELINE_WINDOWS": "0", "RCA_BASELINE_GAP_MIN": "10", "RCA_BASELINE_LEN_MIN": "10", "RCA_ENABLE_FAULT_LEVEL_GATE": "0", "RCA_FAULT_LEVEL_GATE_PENALTY": "0.25", "RCA_FAULT_LEVEL_GATE_NODE_MIN_METRIC": "6.0", "RCA_FAULT_LEVEL_GATE_NODE_MIN_RATIO": "0.75", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_METRIC": "3.0", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_RATIO": "0.70", "RCA_ENABLE_NODE_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_NODE_DOMINANCE_MIN_METRIC": "5.2", "RCA_NODE_DOMINANCE_MIN_RATIO": "0.6", "RCA_NODE_DOMINANCE_MARGIN": "0.03", "RCA_ENABLE_TIDB_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_TIDB_DOMINANCE_MIN_METRIC": "2.6", "RCA_TIDB_DOMINANCE_MIN_RATIO": "0.55", "RCA_TIDB_DOMINANCE_MARGIN": "0.02", "RCA_TIDB_METRIC_SCORE_MULT": "1.8", "RCA_DISABLE_LLM": "1"}`
- 方案B：开启 fault-vs-normal baseline 对照（仅 metrics）（key=baseline_only）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_COMPONENT_PRIOR_SCALE": "1.0", "RCA_USE_LEGACY_MEMORY": "0", "RCA_STRIP_REPLICA_SUFFIX": "0", "RCA_ENABLE_BASELINE_WINDOWS": "1", "RCA_BASELINE_GAP_MIN": "10", "RCA_BASELINE_LEN_MIN": "10", "RCA_ENABLE_FAULT_LEVEL_GATE": "0", "RCA_FAULT_LEVEL_GATE_PENALTY": "0.25", "RCA_FAULT_LEVEL_GATE_NODE_MIN_METRIC": "6.0", "RCA_FAULT_LEVEL_GATE_NODE_MIN_RATIO": "0.75", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_METRIC": "3.0", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_RATIO": "0.70", "RCA_ENABLE_NODE_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_NODE_DOMINANCE_MIN_METRIC": "5.2", "RCA_NODE_DOMINANCE_MIN_RATIO": "0.6", "RCA_NODE_DOMINANCE_MARGIN": "0.03", "RCA_ENABLE_TIDB_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_TIDB_DOMINANCE_MIN_METRIC": "2.6", "RCA_TIDB_DOMINANCE_MIN_RATIO": "0.55", "RCA_TIDB_DOMINANCE_MARGIN": "0.02", "RCA_TIDB_METRIC_SCORE_MULT": "1.8", "RCA_DISABLE_LLM": "1"}`
- 方案C：baseline 对照 + fault_level gate（工程规则版）（key=baseline_plus_gate）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_COMPONENT_PRIOR_SCALE": "1.0", "RCA_USE_LEGACY_MEMORY": "0", "RCA_STRIP_REPLICA_SUFFIX": "0", "RCA_ENABLE_BASELINE_WINDOWS": "1", "RCA_BASELINE_GAP_MIN": "10", "RCA_BASELINE_LEN_MIN": "10", "RCA_ENABLE_FAULT_LEVEL_GATE": "1", "RCA_FAULT_LEVEL_GATE_PENALTY": "0.25", "RCA_FAULT_LEVEL_GATE_NODE_MIN_METRIC": "6.0", "RCA_FAULT_LEVEL_GATE_NODE_MIN_RATIO": "0.75", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_METRIC": "3.0", "RCA_FAULT_LEVEL_GATE_TIDB_MIN_RATIO": "0.70", "RCA_ENABLE_NODE_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_NODE_DOMINANCE_MIN_METRIC": "5.2", "RCA_NODE_DOMINANCE_MIN_RATIO": "0.6", "RCA_NODE_DOMINANCE_MARGIN": "0.03", "RCA_ENABLE_TIDB_METRIC_DOMINANCE_OVERRIDE": "1", "RCA_TIDB_DOMINANCE_MIN_METRIC": "2.6", "RCA_TIDB_DOMINANCE_MIN_RATIO": "0.55", "RCA_TIDB_DOMINANCE_MARGIN": "0.02", "RCA_TIDB_METRIC_SCORE_MULT": "1.8", "RCA_DISABLE_LLM": "1"}`

## 结果汇总（按日期评测；并给出跨日期平均）

| 方案 | 平均LA | 平均TA | 平均Explain | 平均Eff | 平均Final |
|---|---:|---:|---:|---:|---:|
| 方案A：对照（v7: node/tidb dominance；baseline/fault_level 关闭） | 11.61% | 40.77% | 5.93% | 70.18% | 28.56 |
| 方案B：开启 fault-vs-normal baseline 对照（仅 metrics） | 15.18% | 44.05% | 7.85% | 81.87% | 32.66 |
| 方案C：baseline 对照 + fault_level gate（工程规则版） | 13.69% | 45.83% | 8.51% | 81.87% | 32.85 |

## 分日期明细

| date | N | 方案key | LA | TA | Explain | Eff | Final |
|---|---:|---|---:|---:|---:|---:|---:|
| 2025-06-27 | 24.0 | base_safe | 16.67% | 37.50% | 8.70% | 81.87% | 30.72 |
| 2025-06-27 | 24.0 | baseline_only | 16.67% | 45.83% | 17.39% | 81.87% | 34.93 |
| 2025-06-27 | 24.0 | baseline_plus_gate | 12.50% | 54.17% | 17.39% | 81.87% | 36.59 |
| 2025-06-17 | 24.0 | base_safe | 12.50% | 33.33% | 2.33% | 81.87% | 26.75 |
| 2025-06-17 | 24.0 | baseline_only | 12.50% | 41.67% | 4.65% | 81.87% | 30.32 |
| 2025-06-17 | 24.0 | baseline_plus_gate | 20.83% | 41.67% | 9.30% | 81.87% | 34.12 |
| 2025-06-20 | 24.0 | base_safe | 0.00% | 37.50% | 1.89% | 0.00% | 15.19 |
| 2025-06-20 | 24.0 | baseline_only | 4.17% | 50.00% | 11.32% | 81.87% | 30.99 |
| 2025-06-20 | 24.0 | baseline_plus_gate | 4.17% | 50.00% | 11.32% | 81.87% | 30.99 |
| 2025-06-18 | 24.0 | base_safe | 12.50% | 33.33% | 2.00% | 81.87% | 26.72 |
| 2025-06-18 | 24.0 | baseline_only | 16.67% | 37.50% | 2.00% | 81.87% | 30.05 |
| 2025-06-18 | 24.0 | baseline_plus_gate | 12.50% | 41.67% | 2.00% | 81.87% | 30.05 |
| 2025-06-19 | 24.0 | base_safe | 8.33% | 37.50% | 3.64% | 81.87% | 26.88 |
| 2025-06-19 | 24.0 | baseline_only | 12.50% | 45.83% | 5.45% | 81.87% | 32.07 |
| 2025-06-19 | 24.0 | baseline_plus_gate | 8.33% | 45.83% | 5.45% | 81.87% | 30.40 |
| 2025-06-24 | 16.0 | base_safe | 6.25% | 50.00% | 15.79% | 81.87% | 32.27 |
| 2025-06-24 | 16.0 | baseline_only | 31.25% | 50.00% | 10.53% | 81.87% | 41.74 |
| 2025-06-24 | 16.0 | baseline_plus_gate | 25.00% | 50.00% | 10.53% | 81.87% | 39.24 |
| 2025-06-28 | 16.0 | base_safe | 25.00% | 56.25% | 7.14% | 81.87% | 41.40 |
| 2025-06-28 | 16.0 | baseline_only | 12.50% | 37.50% | 3.57% | 81.87% | 28.54 |
| 2025-06-28 | 16.0 | baseline_plus_gate | 12.50% | 37.50% | 3.57% | 81.87% | 28.54 |

## 预测 component 分布（Top-5）

说明：该表用于快速观察是否出现 ‘adservice 坍缩’（例如 Top-1 占比异常高）。

| date | 方案key | Top-5 components（component:count） |
|---|---|---|
| 2025-06-27 | base_safe | adservice:7; tidb-tidb-0:5; checkoutservice:3; aiops-k8s-04:2; tidb-tikv-0:2 |
| 2025-06-27 | baseline_only | adservice:9; checkoutservice:5; emailservice:4; tidb-tidb-0:2; tidb-tikv-0:2 |
| 2025-06-27 | baseline_plus_gate | adservice:9; checkoutservice:5; emailservice:4; aiops-k8s-04:2; aiops-k8s-05:1 |
| 2025-06-17 | base_safe | adservice:7; tidb-tikv-0:4; aiops-k8s-06:2; aiops-k8s-08:2; tidb-tidb-0:2 |
| 2025-06-17 | baseline_only | adservice:8; tidb-tikv-0:8; aiops-k8s-08:2; currencyservice:2; aiops-k8s-03:1 |
| 2025-06-17 | baseline_plus_gate | adservice:8; tidb-tikv-0:5; aiops-k8s-06:3; aiops-k8s-08:2; currencyservice:2 |
| 2025-06-20 | base_safe | adservice:9; checkoutservice:4; tidb-tidb-0:3; aiops-k8s-01:2; aiops-k8s-04:1 |
| 2025-06-20 | baseline_only | adservice:10; checkoutservice:4; aiops-k8s-08:3; aiops-k8s-01:1; aiops-k8s-04:1 |
| 2025-06-20 | baseline_plus_gate | adservice:10; checkoutservice:4; aiops-k8s-08:3; aiops-k8s-01:1; aiops-k8s-04:1 |
| 2025-06-18 | base_safe | adservice:9; aiops-k8s-04:3; tidb-tidb-0:3; checkoutservice:2; tidb-tikv-0:2 |
| 2025-06-18 | baseline_only | adservice:8; tidb-tidb-0:5; tidb-tikv-0:4; aiops-k8s-04:2; aiops-k8s-08:1 |
| 2025-06-18 | baseline_plus_gate | adservice:8; aiops-k8s-04:3; aiops-k8s-08:3; tidb-tidb-0:2; tidb-tikv-0:2 |
| 2025-06-19 | base_safe | adservice:8; aiops-k8s-04:4; aiops-k8s-08:3; aiops-k8s-01:2; cartservice:2 |
| 2025-06-19 | baseline_only | adservice:10; tidb-tikv-0:4; aiops-k8s-04:2; checkoutservice:2; aiops-k8s-06:1 |
| 2025-06-19 | baseline_plus_gate | adservice:10; aiops-k8s-04:3; checkoutservice:2; aiops-k8s-02:1; aiops-k8s-05:1 |
| 2025-06-24 | base_safe | checkoutservice:4; aiops-k8s-04:3; aiops-k8s-08:2; tidb-tikv-0:2; adservice:1 |
| 2025-06-24 | baseline_only | checkoutservice:4; aiops-k8s-08:3; aiops-k8s-06:2; emailservice:2; tidb-tidb-0:2 |
| 2025-06-24 | baseline_plus_gate | checkoutservice:4; aiops-k8s-08:3; aiops-k8s-04:2; aiops-k8s-06:2; emailservice:2 |
| 2025-06-28 | base_safe | aiops-k8s-04:4; checkoutservice:3; tidb-tikv-0:3; aiops-k8s-08:2; aiops-k8s-06:1 |
| 2025-06-28 | baseline_only | tidb-tikv-0:4; aiops-k8s-08:3; adservice:2; aiops-k8s-04:2; checkoutservice:2 |
| 2025-06-28 | baseline_plus_gate | aiops-k8s-08:4; aiops-k8s-04:3; adservice:2; aiops-k8s-02:2; checkoutservice:2 |

## 产物路径
- submissions: `outputs/experiments/la_v8_engineering_rules_p2_seed7/`
- filtered gt: `tmp/filtered/` (gt_YYYY-MM-DD_*.jsonl)
