# 基线误差分析（Final网格v1 / base_p20）

目标：在不增加训练数据的前提下，先用误差分解回答两个问题：
1) LA 为什么低（主要错在什么类型）？
2) 下一步应该优先改哪类规则/特征，才更可能同时提升 LA/TA/Final？

## 分析口径
- 基线 submission：`outputs/experiments/final_grid_v1/` 下的 `base_p20`
- 为避免“UUID 不一致导致大量空预测”的假象，本次分析使用已过滤到同一 UUID 集合的 GT：`tmp/filtered/gt_<date>_n24.jsonl`
- component 判定口径与 judge 一致：若 GT 为 `a->b`，则预测命中 `a` 或 `b` 视为 component 正确。

## 结果（2025-06-07，全量 n=24）
- LA：16.67%
- 预测分布（Top）：adservice(16)、aiops-k8s-07(3)、cartservice(2)…
- 主要混淆（GT→Pred）：
  - recommendationservice → adservice（2）
  - 多个 edge / node / 单服务 GT 被预测成 adservice（各 1）

结论（直观）：基线在这一天存在明显的“向 adservice 收缩”的倾向；同时对 node/edge 类 GT 缺乏区分力。

## 结果（2025-06-08，全量 n=24）
- LA：16.67%
- 预测分布（Top）：adservice(21)，其余极少
- 主要混淆（GT→Pred）：
  - aiops-k8s-07 → adservice（2）
  - recommendationservice → adservice（2）
  - aiops-k8s-05 → adservice（2）
  - 多个服务/副本/edge 被预测成 adservice（各 1）

结论（直观）：这一天的“单一预测塌缩”更严重（几乎全都预测成 adservice），LA 自然难以提高。

## 初步诊断（优先级从高到低）
1) **强先验/热门组件吸引**：共识层的先验会偏向热门服务（如 adservice），在证据不够尖锐时容易“一把梭”。
2) **node/edge 证据不足或未形成稳定胜出**：GT 中 node 与 edge 占比不低，但最终胜出往往被热门服务截胡。
3) **组件标准化差异（副本名、edge 端点）**：例如 `adservice-0/adservice-1` 的 GT 与预测 `adservice` 的关系，在当前 component 判定上并不等价（会直接算错）。

## 下一步改进建议（不依赖训练数据）
- 建议 1（优先做）：开启/调试“query hints 加成”以对抗热门先验塌缩。
  - 开关：`RCA_ENABLE_HINT_BONUS=1`，`RCA_HINT_BONUS=0.25`
  - 预期：当 query 明确出现某个 service token 时，减少被 adservice 抢走的概率。
- 建议 2：针对“副本名”做更谨慎的对齐策略（需要先确认 judge 对 `adservice-0` 是否允许命中 `adservice`；目前从结果看**不允许**）。
- 建议 3：把 node/edge 的胜出条件做成“高精度门槛”，而不是一刀切 boost（你之前 node boost 伤 LA 的现象与此一致）。

## 复现命令
- 2025-06-07：
  - `python tools/analyze_errors.py -g tmp/filtered/gt_2025-06-07_n24.jsonl -s outputs/experiments/final_grid_v1/sub_2025-06-07_n24_base_p20.jsonl --topk 25`
- 2025-06-08：
  - `python tools/analyze_errors.py -g tmp/filtered/gt_2025-06-08_n24.jsonl -s outputs/experiments/final_grid_v1/sub_2025-06-08_n24_base_p20.jsonl --topk 25`
