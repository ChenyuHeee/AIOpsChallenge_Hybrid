# 坍缩原因诊断（2025-06-07/08）

目标：在固定数据口径下，比较多种方案对 Final（以及 LA/TA/Explainability/Efficiency）的影响。

## 试验设置
- metadata: `../metadata_phase1.csv`
- ground truth: `../AIOpsChallengeJudge/ground_truth_phase1.jsonl`
- telemetry root: `../data`
- dates（按天全量）: 2025-06-07, 2025-06-08
- suite slug: `collapse_diag_v1`（对应 outputs/experiments/collapse_diag_v1/）

## 候选方案
- 方案A：基线（对照）（key=base_p20）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_COMPONENT_PRIOR_SCALE": "1.0", "RCA_STRIP_REPLICA_SUFFIX": "1"}`
- 方案B：关闭 component 先验（scale=0）（key=no_prior）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_COMPONENT_PRIOR_SCALE": "0.0", "RCA_STRIP_REPLICA_SUFFIX": "1"}`
- 方案C：隔离记忆文件（避免 legacy component_success 影响）（key=mem_clean）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_COMPONENT_PRIOR_SCALE": "1.0", "RCA_STRIP_REPLICA_SUFFIX": "1", "RCA_MEMORY_PATH": ".aiops_memory.clean.json"}`
- 方案D：关闭先验 + 隔离记忆文件（key=no_prior_mem_clean）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_COMPONENT_PRIOR_SCALE": "0.0", "RCA_STRIP_REPLICA_SUFFIX": "1", "RCA_MEMORY_PATH": ".aiops_memory.clean.json"}`
- 方案E：下调 Trace 权重（避免 trace 噪声主导）（key=trace_down）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_COMPONENT_PRIOR_SCALE": "1.0", "RCA_STRIP_REPLICA_SUFFIX": "1", "RCA_WEIGHT_TRACE": "1.10"}`
- 方案F：下调 Trace 权重 + 关闭先验（key=trace_down_no_prior）
  - env: `{"RCA_COMPONENT_SOURCE": "consensus", "RCA_WINDOW_PADDING_MIN": "20", "RCA_ENABLE_MODALITY_BONUS": "0", "RCA_ENABLE_HINT_BONUS": "0", "RCA_COMPONENT_PRIOR_SCALE": "0.0", "RCA_STRIP_REPLICA_SUFFIX": "1", "RCA_WEIGHT_TRACE": "1.10"}`

## 结果汇总（按日期评测；并给出跨日期平均）

| 方案 | 平均LA | 平均TA | 平均Explain | 平均Eff | 平均Final |
|---|---:|---:|---:|---:|---:|
| 方案A：基线（对照） | 16.67% | 75.00% | 24.92% | 81.87% | 47.35 |
| 方案B：关闭 component 先验（scale=0） | 16.67% | 72.92% | 22.75% | 81.87% | 46.30 |
| 方案C：隔离记忆文件（避免 legacy component_success 影响） | 14.58% | 72.92% | 12.40% | 81.87% | 44.43 |
| 方案D：关闭先验 + 隔离记忆文件 | 10.42% | 64.58% | 7.29% | 81.87% | 38.92 |
| 方案E：下调 Trace 权重（避免 trace 噪声主导） | 14.58% | 75.00% | 24.92% | 81.87% | 46.51 |
| 方案F：下调 Trace 权重 + 关闭先验 | 16.67% | 66.67% | 21.66% | 81.87% | 43.69 |

## 分日期明细

| date | N | 方案key | LA | TA | Explain | Eff | Final |
|---|---:|---|---:|---:|---:|---:|---:|
| 2025-06-07 | 24.0 | base_p20 | 16.67% | 70.83% | 23.91% | 81.87% | 45.58 |
| 2025-06-07 | 24.0 | no_prior | 16.67% | 66.67% | 19.57% | 81.87% | 43.48 |
| 2025-06-07 | 24.0 | mem_clean | 25.00% | 70.83% | 17.39% | 81.87% | 48.26 |
| 2025-06-07 | 24.0 | no_prior_mem_clean | 16.67% | 58.33% | 10.87% | 81.87% | 39.27 |
| 2025-06-07 | 24.0 | trace_down | 12.50% | 70.83% | 23.91% | 81.87% | 43.91 |
| 2025-06-07 | 24.0 | trace_down_no_prior | 16.67% | 62.50% | 17.39% | 81.87% | 41.59 |
| 2025-06-08 | 24.0 | base_p20 | 16.67% | 79.17% | 25.93% | 81.87% | 49.11 |
| 2025-06-08 | 24.0 | no_prior | 16.67% | 79.17% | 25.93% | 81.87% | 49.11 |
| 2025-06-08 | 24.0 | mem_clean | 4.17% | 75.00% | 7.41% | 81.87% | 40.59 |
| 2025-06-08 | 24.0 | no_prior_mem_clean | 4.17% | 70.83% | 3.70% | 81.87% | 38.56 |
| 2025-06-08 | 24.0 | trace_down | 16.67% | 79.17% | 25.93% | 81.87% | 49.11 |
| 2025-06-08 | 24.0 | trace_down_no_prior | 16.67% | 70.83% | 25.93% | 81.87% | 45.78 |

## 预测 component 分布（Top-5）

说明：该表用于快速观察是否出现 ‘adservice 坍缩’（例如 Top-1 占比异常高）。

| date | 方案key | Top-5 components（component:count） |
|---|---|---|
| 2025-06-07 | base_p20 | adservice:19; cartservice:2; aiops-k8s-07:1; checkoutservice:1; shippingservice:1 |
| 2025-06-07 | no_prior | adservice:16; aiops-k8s-07:3; cartservice:2; checkoutservice:1; emailservice:1 |
| 2025-06-07 | mem_clean | checkoutservice:17; adservice:2; cartservice:2; aiops-k8s-07:1; emailservice:1 |
| 2025-06-07 | no_prior_mem_clean | checkoutservice:10; aiops-k8s-07:5; cartservice:4; aiops-k8s-03:2; emailservice:1 |
| 2025-06-07 | trace_down | adservice:20; cartservice:2; aiops-k8s-07:1; shippingservice:1 |
| 2025-06-07 | trace_down_no_prior | adservice:15; aiops-k8s-07:4; cartservice:2; checkoutservice:1; emailservice:1 |
| 2025-06-08 | base_p20 | adservice:23; checkoutservice:1 |
| 2025-06-08 | no_prior | adservice:21; aiops-k8s-08:1; checkoutservice:1; emailservice:1 |
| 2025-06-08 | mem_clean | checkoutservice:20; adservice:3; aiops-k8s-07:1 |
| 2025-06-08 | no_prior_mem_clean | checkoutservice:11; aiops-k8s-07:4; aiops-k8s-03:2; aiops-k8s-04:2; aiops-k8s-08:2 |
| 2025-06-08 | trace_down | adservice:23; checkoutservice:1 |
| 2025-06-08 | trace_down_no_prior | adservice:19; aiops-k8s-04:1; aiops-k8s-07:1; aiops-k8s-08:1; checkoutservice:1 |

## 产物路径
- submissions: `outputs/experiments/collapse_diag_v1/`
- filtered gt: `tmp/filtered/` (gt_YYYY-MM-DD_*.jsonl)
